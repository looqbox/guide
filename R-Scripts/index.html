<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>R Scripts - Looqbox User Guide</title>
        <link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link rel="stylesheet" href="../css/highlight.css">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/extra.css" rel="stylesheet">
        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.3/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <script src="../js/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.3.7.min.js"></script>
        <script src="../js/highlight.pack.js"></script>
         
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="..">Looqbox User Guide</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Home</a>
                </li>
            
            
            
                <li >
                    <a href="../Admin-Interface/">Admin Interface</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">R Scripts</a>
                </li>
            
            
            
                <li >
                    <a href="../Read-more/">Read more</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                    <li >
                        <a rel="next" href="../Admin-Interface/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../Read-more/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
                <div class="row">
                    <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
      
    
        <li class="main active"><a href="#r-scripts">R Scripts</a></li>
        
            <li><a href="#setup-for-the-tutorial">Setup for the Tutorial</a></li>
        
            <li><a href="#basics">Basics</a></li>
        
            <li><a href="#advanced">Advanced</a></li>
        
            <li><a href="#good-practices-in-r">Good practices in R</a></li>
        
            <li><a href="#model-scripts">Model Scripts</a></li>
        
    
    
    </ul>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="r-scripts">R Scripts</h1>
<blockquote>
<p>This tutorial assumes you don't have any previous knowledge in the Looqbox Package.</p>
</blockquote>
<!--
## Prerequisites

- R knowledge
-->

<h2 id="setup-for-the-tutorial">Setup for the Tutorial</h2>
<p>This documentation's objective is to introduce you to the guidelines for creating organized and efficient R scripts for Looqbox as well as to make you confortable with the looqbox package and with the tool's environment and workflow. In this section we will focus on the creation and editing of the R scripts, so we recomend using Rstudio as the development environment.</p>
<p>You can either write the code in your RStudio Serve, or you can set up a local development environment on your computer and use your local RStudio.</p>
<h3 id="rstudio-serve-setup">RStudio Serve Setup</h3>
<p>This is the quickest way to get started!</p>
<p>Open your looqbox instance on port 8787 (usually: <a href="http://localhost:8787">http://localhost:8787</a>), enter <strong>rstudio</strong> as username and the <strong>password</strong> you created in the <a href="#installation">installation</a> and you're almost ready to go.</p>
<p>Under addins, select Looqbox and enter your looqbox <strong>username</strong> and <strong>host</strong> (if they're not already there).</p>
<p align="center">
  <img src="../img/addin.png" width="500">
</p>

<p>It is also recomended to have Looqbox opened on another tab, as your tests will be published there.</p>
<p>You now have everything you need to begin, go ahead to the <a href="#basics">basics section</a>.</p>
<h2 id="basics">Basics</h2>
<h3 id="script-sctructure">Script sctructure</h3>
<p>In this section, you'll learn about the structure that your script should be implemented.</p>
<h4 id="dependencies">Dependencies</h4>
<p>In order to develop a script for Looqbox you should use our Looqbox Package. The package allows you to interact with the interface and help you structure your data to be displayed in our client.</p>
<pre><code class="looqbox">library(looqbox)
</code></pre>

<h4 id="getdata">get.data</h4>
<h4 id="looqresponse">looq.response</h4>
<p>This block is where your script will start the execution, simulating a main function. Inside it, you should use <code>looq.lookTag()</code>  to receive the value inside a looqbox tag from the parser.</p>
<p>In this case, we are creating a looqbox standard message box and storing it in msg variable. In the first parameter we're passing a <code>paste</code> with the string collected above. The second parameter is the style type to display the box. </p>
<p>Finally, we are creating a looqbox frame to be placed inside a board with <code>looq.responseFrame()</code>.</p>
<pre><code class="looqbox">looq.response &lt;- function(par) {

  # Receives the value inside a looqbox tag. In this case, we're looking for 
  # $quotes tag and storing it in quotes
  quotes &lt;- looq.lookTag(&quot;$quotes&quot;, par)

  # Creates a looqbox standard message box and store it in msg variable. In
  # the first parameter we're passing a paste with the string collected above
  # the second parameter is the style type to display the box. 
  msg &lt;- looq.objMessage(
    paste(&quot;Hurray, my installation is working!!\n&quot;, quotes),
    &quot;alert-success&quot;
  )

  # Creates a looqbox frame to be placed inside a board
  looq.responseFrame(msg)
}
</code></pre>

<h4 id="test-block">Test Block</h4>
<p>This block is used to test your response from <strong>RStudio</strong>, allowing you to simulate our parser and test your script without saving it in Looqbox client. If you have configured your Looqbox addin correctly, you can run your script using <strong>Ctrl + Shift + S</strong> and it will be displayed in your client.</p>
<pre><code class="looqbox">looq.testQuestion(
  list(
    &quot;$quotes&quot; = &quot;My test sentence&quot;
  )
)
</code></pre>

<h3 id="essential-functions">Essential functions</h3>
<p>Now that you have a general understanding of how a script is properly constructed, let us go over a few of the package's most important functions. </p>
<p>NOTE: In this material we'll be working with practical examples. If you wish to understand the full depth and parameters of each of these functions please refer to the package documentation.</p>
<h4 id="looqlooktag">looq.lookTag</h4>
<p>Normally, the first thing your code will do once it enters your <code>looq.response()</code>(main) function, is receive information from the parser (in JSON format). From this, we have to extract information such as entities and tags, which will be used as parameters in <code>get.data()</code>. </p>
<ul>
<li><code>looq.lookTag()</code> acomplishes this task, searching for specific tags and returning their values.</li>
</ul>
<pre><code class="looqbox">company &lt;- looq.lookTag(&quot;$company&quot;, par)
</code></pre>

<p>In the example above, <code>looq.lookTag</code> takes two parameters:</p>
<ul>
<li><code>"$company"</code>: The entity or pattern it will search for. </li>
<li><code>par</code>: the parser string, as received by <code>looq.response(par)</code> </li>
</ul>
<p>It will then, return the company value and assign it to the variable <code>company</code>.</p>
<p>If a certain value is an optional parameter for a question, <code>looq.lookTag()</code> also accepts a third parameter for setting a default value (should be a list). </p>
<pre><code class="looqbox">date &lt;- looq.lookTag(&quot;$date&quot;, par, list(c('2018-01-01', '2019-01-01')))
</code></pre>

<p>In the code above, if no <code>$date</code> value is recognised by the parser it will choose the default, in this case, the period starting yesterday and ending today (whenever that is).</p>
<h4 id="looqmap">looq.map</h4>
<p>This function is, perhaps, the core of the whole script.</p>
<pre><code class="looqbox">looq.map(get.data, date, company)
</code></pre>

<p>What it does is fairly simple, the first argument is your <code>get.data()</code> function, and the remaining are  variables defined by <code>looq.lookTag()</code>. </p>
<ul>
<li><code>looq.map()</code> calls the function and passes the variables as arguments to it.</li>
<li>Additionally, it wraps everything in a Looqbox response frame making <code>get.data</code>'s 
output intelligible by the interface. </li>
</ul>
<h4 id="looqsqlexecute">looq.sqlExecute</h4>
<p>Now that we've got <code>looq.response</code> covered, we'll go inside <code>get.data</code>. Think of it as the backstage of your script, it's where everything is prepared so that your main function keeps neat.</p>
<p>Most of our scripts involve some kind of query to a database, <code>looq.sqlExecute()</code> is a funtion that makes this interaction extremely simple. </p>
<pre><code class="looqbox"># We generally store looq.sqlExecute's output in a variable called r
r &lt;- looq.sqlExecute(&quot;mySQLDev&quot;, sql, list(dateInt[1], dateInt[2], company, value))

# A simple error test follows the query, checking for data absence
if(r$rows == 0) return(paste(&quot;No data found from:\n&quot;, dateInt[1], &quot;to&quot;, dateInt[2]))
</code></pre>

<p>Normally it will take three arguments:</p>
<ul>
<li><code>"mySQLDB"</code>: the database's name, as it was registered in the interface under connections.</li>
<li><code>sql</code>: a string containing the SQL query (we'll cover it in depth) </li>
<li><code>...</code>: a list of parameters that will be inserted into the query.</li>
</ul>
<p>In a simple manner, <code>looq.sqlExecute</code> does exatly what the name implies, it executes your query within the database, but more than that, it lets you insert values in the query. Take the following example string:</p>
<pre><code class="looqbox">sql &lt;- &quot;
    SELECT
        EXAMPLE,
        TEST,
        FIELD,
        DATE
    FROM example.table
    WHERE 1=1           
        AND DATE &gt;= DATE_ADD(`1`, INTERVAL +3 HOUR) 
        AND DATE &lt; DATE_ADD(`2`, INTERVAL +3 HOUR)
        AND COMPANY = `3`
        AND VALUE = `4`
    ORDER BY DATE DESC
&quot;
</code></pre>

<p>The values between backticks (<code>` `</code>)  are recognised by the function and substituted with the variables passed in the third argument of <code>looq.SQLExecute</code>, in order of appearance. </p>
<p>Say that:</p>
<pre><code class="looqbox">company &lt;- 0
dateInt &lt;- c('2018-07-09', '2018-08-09')
value &lt;- 1120
</code></pre>

<p>The query sent to the database would be:</p>
<pre><code class="looqbox">SELECT
    EXAMPLE,
    TEST,
    FIELD,
    DATE
FROM my.exampleDB
WHERE 1=1
    AND DATE &gt;= DATE_ADD('2018-07-09', INTERVAL +3 HOUR) 
    AND DATE &lt; DATE_ADD('2018-08-09', INTERVAL +3 HOUR)
    AND COMPANY = 0
    AND VALUE = 1120
ORDER BY DATE DESC
</code></pre>

<p>Easy right? And it gets better, <code>looq.sqlExecute</code> returns a <code>looq.objTable</code>, an object from the package that is ready to be imported to the interface.</p>
<h4 id="looqobjtable-and-its">looq.objTable and it's</h4>
<p>The most common answer to Looqbox questions comes in the form of tables, but rather than using comon objects as <code>data.frame</code> or <code>tbl</code> we have developed a special object, which is recognised by the interface and will help you create espoke tables, as it has a number of built-in customization options.</p>
<p>Well go through it's most important parameters here, more advanced options will be treated in the 
<a href="#advanced">Advanced Section</a>.</p>
<h4 id="data">Data</h4>
<pre><code class="looqbox">r$data
</code></pre>

<p>All of the data retrieved from queries or imported from elsewhere will be available in this variable, which is a <code>tbl</code>. </p>
<h4 id="title">Title</h4>
<p>You can create a title for your table with <code>r$title</code>, which will be visible as a header. Another style option is <code>r$framedTitle</code>. Go ahead and try it out!</p>
<p>The <code>r$title</code> format accepts multiple lines, creating subtitles or passing other info as a header, <code>r$framedTitle</code> accepts only a string, but you may combine them to create interesting headers.</p>
<pre><code class="looqbox"># Simple title
r$title &lt;- &quot;Simple title&quot;

# Example with framed title
r$framedTitle &lt;- &quot;Framed title&quot;

# Title with date
r$title &lt;- c(
    &quot;My title&quot;,
    looq.titleWithDate(&quot;Períod:&quot;, dateInt)
)
</code></pre>

<h4 id="style">Style</h4>
<p>Add styling to single or multiple columns through <code>r$value$Style</code>. Good examples are values that turn red if negative but green if positive. The color can be defined as either hex(#fff) or rgb(255,255,255). </p>
<pre><code class="looqbox">
# Styling single column
r$valueStyle$Column &lt;- style

# Styling multiple columns at once
r$valueStyle &lt;- list(
    &quot;Column1&quot; = style,
    &quot;Column2&quot; = style
)
</code></pre>

<h4 id="formating-my-data">Formating my data</h4>
<p><code>r$valueFormat</code> lets you format numbers and dates, adding percentages, defining number of decimal points son so on.  You should write the names of each column followed by the format.</p>
<pre><code class="looqbox">r$valueFormat &lt;- list(
    &quot;numeric column&quot; = &quot;number:2&quot;,
    &quot;percent column&quot; = &quot;percent:2&quot;
)
</code></pre>

<h4 id="total-line">Total line</h4>
<p>Add a total line to your table, it can be defined for each column. If a column is left blank it will be filled with <code>-</code> by default.</p>
<pre><code class="looqbox">r$total &lt;- list(
    `Column 1` = &quot;total&quot;,
    `Column 2` = sum(r$data$`Column 2`)
)
</code></pre>

<h4 id="drill-down">Drill Down</h4>
<p>To add drill down options that link to other scripts, you should use <code>r$ValueLink$[Your Column Here]</code>. The question text will be posted as a new question, efectively linking the scripts together. </p>
<p>Using <code>paste</code> or <code>paste0</code> we can ad variables or values to the link, or, as you can see below, even add values from within the table, by pasting the desired <code>r$data$column</code>. </p>
<p>The <code>"text"</code> parameter will add a title to your link, which is essential when multiple drills are made from the same column.</p>
<pre><code class="looqbox"># Simple drill
r$valueLink$Column &lt;- &quot;my question text here&quot;

# Simple drill with variable
r$valueLink$Column &lt;- paste(&quot;my question text here with this value&quot;, 203)

# Text box drill
r$valueLink$Column &lt;- list(
    list(&quot;text&quot; = &quot;by User&quot;, &quot;link&quot; = paste(&quot;my question with this column&quot;, r$data$Column2)),
    list(&quot;text&quot; = &quot;by Company&quot;, &quot;link&quot; = paste(&quot;my other question with this column&quot;, r$data$Column2))
)
</code></pre>

<h4 id="pagination">Pagination</h4>
<p>Adds pagination of the specified size.</p>
<pre><code class="looqbox">r$paginationSize &lt;- 25
</code></pre>

<h4 id="searchbar">Searchbar</h4>
<p>Boolean that adds a searchbar to the table(<code>FALSE</code> by default). </p>
<pre><code class="looqbox">r$searchable &lt;- T
</code></pre>

<h2 id="advanced">Advanced</h2>
<h3 id="other-vizualizations">Other Vizualizations</h3>
<h4 id="graphs">Graphs</h4>
<h4 id="media">Media</h4>
<h4 id="deeper-into-looqobjtable">Deeper into looq.objTable</h4>
<h4 id="looqresponseframe">looq.responseFrame</h4>
<h3 id="advanced-package-functions">Advanced Package Functions</h3>
<h2 id="good-practices-in-r">Good practices in R</h2>
<p>In this first section we'll talk a little bit about styling and good practices in R. Here at Looqbox, we like the <code>cammelCase</code>, so stick to it as much as you can when naming files, functions, variables and what-not.</p>
<p><strong>Good names:</strong></p>
<ul>
<li><code>newFile.r</code>: even though R uses .R as a default extension, prefer .r (lower case) for Looqbox scripts</li>
<li><code>getData()</code>: when naming functions, the ideal is to use verbs in it's name</li>
<li><code>newVariable</code>: for variables, it is better to use nouns</li>
<li><code>NOT_VARIABLE</code>: hey! this case is a little different, when defining constant values, use UPPER CASE all the way through!</li>
</ul>
<p>Always try to use names that have something to do with the object! Keep in mind that more often than not you or someone else will have to read, debug, or modify your code, so don't go writing some undecipherable Aztec codex!!</p>
<p>Keep your code clean and with a single kind of indentation, we use 2 spaces by default. Enough reading for know, the rest, I'll show you in an example block of code.</p>
<pre><code class="looqbox">sayHello &lt;- function(language){ # Always use '&lt;-' for assignment, never '='

  hello &lt;- c(&quot;Hello World&quot;, 'Olá Mundo') # Give double quotes priority!!
     # ^  ^                ^
     # Put spaces between operators and AFTER commas!

  if (language == &quot;en-uk&quot;){     # Opening brackets don't have a whole line to 
    say &lt;- hello[1]             # themselves.      
  } else if (language == &quot;pt-br&quot;){
     say &lt;- hello[2]  
  } # Now, closing brackets are the opposite, they should always be alone unless
    # accompanied by an 'else'

  if (erro) return(&quot;Erro x&quot;)# Only use this kind of if format to treat errors, prefer the {} type

  say   
}
</code></pre>

<p>Also, in order to write code that remains readable once uploaded to the interface we should keep our lines below 80 characters in length. You can set a margin in RStudio to help you stay true to that.</p>
<p>Just go to Preferences &gt; Code &gt; Display, and check the <em>Show margin</em> box. Type in 80 under <em>Margin column</em>.</p>
<p align="center">
  <img src="../img/margin.png" width="500">
</p>

<h2 id="model-scripts">Model Scripts</h2></div>
                </div>
        </div>

    <hr>
    <footer class="container">
        
        <center>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</center>
    </footer>
        <script src="../js/base.js"></script>
        <script src="../search/require.js"></script>
        <script src="../search/search.js"></script>
    </body>
</html>